# 5. 서비스

## 0. 서비스가 필요한 이유

- pod는 일회성이다.
- pod 수를 줄이거나, 클러스터 node의 장애로 node간 이동이 발생한다.
- pod가 node에 할당된 이후 시작하기 전에 IP를 할당한다.
- 클라이언트에서 서버의 IP를 알 수 없다.

## 1. 서비스란

- 동일한 서비스를 제공하는 pod 그룹에 대한 단일 진입 지점이다.
- 서비스가 존재하는동안 변경되지 않는 IP 주소와 Port를 가진다,
- 해당 서비스와 연결된 pod중 하나로 전달한다.

### 1-1 서비스 생성

- 서비스는 서비스 뒷단의 모든 파드로 로드밸런싱 된다.
- 테이블 셀렉터를 사용해 특정 서비스의 일부분으로 정의한다.
- 생성하는 방법은 kubectl expose로 생성하는 방법과, YAML 디스크립터를 통해 생성할 수 있다.

- 컨테이너에 명령 실행 동작

  ```
  1. kubectl exec
  2. 컨테이너 내에서 실행
  3. 서비스로 요청을 보냄
  4. 서비스는 로드벨런싱으로 요청을 임의의 pod로 전달
  5. pod는 응답을 컨테이너로 전달
  6. kubectl로 보내고 화면에 출력
  ```

- 세션 어피니티

  특정 클라이언트의 모든 요청을 특정 pod로 리디렉션 하려면, sessionAffinity속성을 기본값이 아닌, ClientIP로 설정한다.

- 멀티포트

  서비스는 단일포트와 멀티포트를 지원하지만, 멀티포트가 있는 서비스를 만들때에는, 포트의 이름을 지정해야한다.

### 1-2 서비스 검색

- 서비스를 생성하면, 서비스가 유지되는 동안 생성된 IP주소와 Por는 유지된다. 
- 서비스 검색은 환경변수를 통한 검색, DNS를 통해 검색한다.

## 2. 클러스터 외부에 있는 서비스 연결

- K8s 바깥의 서비스들을 수동으로 연결가능
- 외부 IP와 포트로 연결을 전달하는 방식이다. 이 경우 로드밸런싱과 서비스 검색 모두를 활용 할 수 있다.
- 서비스의 엔드포인트를 수동우로 구성할 때, 정규화된 도메인 이름으로 외부서비스 참조 가능

## 3. 외부 클라이언트에 서비스 노출

### 3-1 외부에서 서비스를 접근하는 방법

```
1. 노드포트로 서비스 유형 설정
2. 서비스 유형을 노드포트 유형의 확장인 로드밸런서로 설정
3. 단일 IP 주소로 여러 서비스를 노출하는 인그레스 리소스 만들기
```



